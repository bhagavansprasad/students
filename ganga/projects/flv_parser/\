#include "stdio.h"
#include "fcntl.h"
#include "unistd.h"
#include "stdbool.h"
#include "defs.h"

int fd0;
int read_flv_tags(int fd)
{
	static temp=0;
	int a = 0, c = 0, i = 0, n = 0, wval = 0, wretval = 0, retval = 0, mask = 0x1F; 
	char buff[10000] = " ";
	char *p;
	char *dp;
	char *tp; 
	char *sp = (char *)&tdata.stream_id;
	int tsfd = 0, tslen = 0;
	char tempbuff[1000] = " ";
	extern fd5,tfd;
	char buff1[20] = " ";

	fd0 = open("f.txt", O_APPEND |O_RDWR | O_CREAT, 0744);
	retval = read(fd, buff1, 4);

	if(retval < 4)
		return 1;

	else
	{
		p = (char *)&tdata.previoustag;

		for (i = 0 ; i <= 3 ; i++)
		{
			*p = buff1[i];
			p++;
		}

		retval = read(fd, buff, 1);

		a = buff[0];
		n = ((a >> 6) & 3);
		tdata.reserved = n;

		tdata.filter = ((a >> 5) & 1);
		
		c = a & mask;
		tdata.tag_type = c;
		if(tdata.tag_type != 8)
		{
			wretval = write(fd5, buff1, 4);
			wretval = write(fd5, buff, 1);
		}

		retval = read(fd, buff, 3);
		
		if(tdata.tag_type != 8)
		{
			wretval = write(fd5, buff, 3);
		}
		wval=write(fd0,buff,retval);

		tdata.data_size = 0;
		dp = (char *)&tdata.data_size;

		for(i = 2; i >= 0; i--)
		{
			*dp = buff[i];		
			dp++;
		}

		retval = read(fd, buff, 3);
		
		if(tdata.tag_type != 8)
		{
			wretval = write(fd5, buff, 3);
		}
		
		wval=write(fd0,buff,retval);
		tdata.timestamp = 0; 
		tp= (char *)&tdata.timestamp;

		for(i = 2; i >= 0; i--)
		{
			*tp = buff[i];
			tp++;
		}

		retval = read(fd, buff, 1);
		
		if(tdata.tag_type != 8)
		{
			wretval = write(fd5, buff, 1);
		}
		wval=write(fd0,buff,retval);

		tdata.timestamp_extended = buff[0];

		retval = read(fd, buff, 3);
		
		if(tdata.tag_type != 8)
		{
			wretval = write(fd5, buff, 3);
			retval = read(fd, buff, tdata.data_size);
			wretval = write(fd5, buff, tdata.data_size);
		}

		for(i = 2; i >= 0; i--)
		{
			*sp = buff[i];
			sp++;
		}
		lseek(fd5, -tdata.data_size, SEEK_CUR);                

		tdata.previoustag = tdata.data_size;
	}

	return tdata.tag_type;
}
